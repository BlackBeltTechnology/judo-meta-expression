@cached
operation EXPR!ImmutableCollection getObjectType() {
    return self.elementName.getObjectType();
}

@cached
operation EXPR!CollectionFilterExpression getObjectType() {
    var base = self.collectionExpression.getObjectType();
    if (base.isDefined()) {
        if (self.filter.isDefined()) {
            if (self.filter.filterAndCastingType.isDefined()) {
                return self.filter.filterAndCastingType.getObjectType();
            } else {
                return base;
            }
        } else {
            return base;
        }
    }
}

@cached
operation EXPR!CollectionNavigationFromObjectExpression getReference() {
    var objectType = self.objectExpression.getObjectType();
    if (objectType.isDefined()) {
        return objectType.getReferenceType(self.referenceName);
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionNavigationFromObjectExpression getObjectType() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.getTarget();
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionNavigationFromCollectionExpression getReference() {
    var collectionType = self.collectionExpression.getObjectType();
    if (collectionType.isDefined()) {
        return collectionType.getReferenceType(self.referenceName);
    } else {
        return null;
    }
}

@cached
operation EXPR!ObjectNavigationFromCollectionExpression getReference() {
    var collectionType = self.collectionExpression.getObjectType();
    if (collectionType.isDefined()) {
        return collectionType.getReferenceType(self.referenceName);
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionNavigationFromCollectionExpression getObjectType() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.getTarget();
    } else {
        return null;
    }
}

@cached
operation EXPR!ObjectNavigationFromCollectionExpression getObjectType() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.getTarget();
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionNavigationFromObjectExpression isCollection() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.isCollection();
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionNavigationFromCollectionExpression isCollection() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.isCollection();
    } else {
        return null;
    }
}

@cached
operation EXPR!ObjectNavigationFromCollectionExpression isCollection() {
    var ref = self.getReference();
    if (ref.isDefined()) {
        return ref.isCollection();
    } else {
        return null;
    }
}

@cached
operation EXPR!CollectionVariableReference getObjectType() {
    return self.variable.getObjectType();
}

@cached
operation EXPR!SortExpression getObjectType() {
    return self.collectionExpression.getObjectType();
}

@cached
operation EXPR!OrderBy getOwner() {
    var sortExpression = EXPR!SortExpression.all.selectOne(e | e.orderBy = self);
    if (sortExpression.isDefined()) {
        return sortExpression;
    }
    
    self.toString().println("Unable to detect owner of order by expression: ");
    
    return null;
}

@cached
operation EXPR!OrderBy getObjectType() {
    var owner = self.getOwner();
    
    if (owner.isDefined()) {
        return owner.getObjectType();
    } else {
        return null;
    }
}

@cached
operation EXPR!IntegerAggregatedExpression getAttributeType() {
    var collectionType = self.collectionExpression.getObjectType();
    
    if (collectionType.isDefined()) {
        return collectionType.getAttributeType(self.attributeName);
    } else {
        return null;
    }
}

@cached
operation EXPR!DecimalAggregatedExpression getAttributeType() {
    var collectionType = self.collectionExpression.getObjectType();
    
    if (collectionType.isDefined()) {
        return collectionType.getAttributeType(self.attributeName);
    } else {
        return null;
    }
}
